<mat-toolbar>
    <mat-toolbar-row class="navigation-header">
        <li class="breadcrumb-item">
            <a [routerLink]="['/entries','knowledge_bases']">
                <strong>
                    {{ "header.knowledge" | translate }}
                </strong>
            </a>
        </li>
        <li class="breadcrumb-item">
            {{ "header.edit" | translate }}
        </li>
        <li class="breadcrumb-item">
            {{ base.name }}
        </li>
    </mat-toolbar-row>
</mat-toolbar>

<mat-toolbar class="page-header" role="heading">
    <mat-toolbar-row>
        <button mat-raised-button color="blue" title="Create a new entry" (click)="
        showForm = true;
        editMode = 'new';
        entryForm.reset();
        selectedKnowledgeId = null;
        itemsSelected = [];
      ">
            <i class="fas fa-plus"></i>
            @switch(base.category){
            @case('cookie'){
            {{ "knowledge.cookie.new_entry" | translate }}
            }

            @case('localstorage'){
            {{ "knowledge.localstorage.new_entry" | translate }}
            }
            }
        </button>

        <button mat-raised-button color="blue" title="Create a new entry" (click)="updateEntries()">
            <i class="fas fa-refresh"></i>
            {{ "knowledge.update_knowledge" | translate }}
        </button>
    </mat-toolbar-row>
    @if(showModal){
    <mat-toolbar-row>
        <app-modal (clickOnClose)="showModal = false">
            <b style="color: red"> Error with database updates : malformed file !</b>
        </app-modal>
    </mat-toolbar-row>
    }

</mat-toolbar>

<div class="container base-mainContainerBlock base-knowledges_base">
    @if(updateKnowledges.length >0){
    <div class="row">
        <div class="small-9 medium-9 columns">
            <app-compare [knowledgesService]="KnowledgesService" [base]="base" [updateKnowledges]="updateKnowledges"
                (closeEvent)="updateKnowledges = []" (refreshEvent)="refresh()"
                (deleteEvent)="delete($event)">
            </app-compare>
        </div>
    </div>
    }


    <div class="row">
        <div class="small-9 medium-9 columns">
            @switch(base.category){
            @case('cookie'){
            <ng-container [formGroup]="searchCookieForm">
                <mat-form-field appearance="fill">
                    <mat-label>{{ "knowledge.domain" | translate }}</mat-label>
                    <input formControlName="searchDomain" matInput />
                    @if(!searchCookieForm.value.searchDomain){
                    <mat-icon matSuffix>search</mat-icon>
                    }@else if(searchCookieForm.value.searchDomain.length>0){
                    <mat-icon (click)="searchCookieForm.patchValue({searchDomain:''})" matSuffix>close
                    </mat-icon>
                    }


                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>{{ "knowledge.name" | translate }}</mat-label>
                    <input formControlName="searchName" matInput />
                    @if(!searchCookieForm.value.searchName){
                    <mat-icon matSuffix>search</mat-icon>
                    }@else if(searchCookieForm.value.searchName.length>0){
                    <mat-icon (click)="searchCookieForm.patchValue({searchName:''})" matSuffix>close
                    </mat-icon>
                    }
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>{{ "knowledge.category" | translate }}</mat-label>
                    <mat-select formControlName="searchCategory">
                        <mat-option [value]=""></mat-option>
                        @for(cat of categories; track cat){
                            <mat-option [value]="cat">{{cat}}</mat-option>
                        }

                    </mat-select>
                </mat-form-field>
            </ng-container>
            }
            @case('localstorage'){
            <ng-container [formGroup]="searchLocalStorageForm">
                <mat-form-field appearance="fill">
                    <mat-label>{{ "knowledge.host" | translate }}</mat-label>
                    <input formControlName="searchHost" matInput />
                    @if(!searchCookieForm.value.searchHost){
                    <mat-icon matSuffix>search</mat-icon>
                    }@else if(searchCookieForm.value.searchHost.length>0){
                    <mat-icon (click)="searchCookieForm.patchValue({searchHost:''})" matSuffix>close
                    </mat-icon>
                    }


                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>{{ "knowledge.key" | translate }}</mat-label>
                    <input formControlName="searchKey" matInput />
                    @if(!searchCookieForm.value.searchKey){
                    <mat-icon matSuffix>search</mat-icon>
                    }@else if(searchCookieForm.value.searchKey.length>0){
                    <mat-icon (click)="searchCookieForm.patchValue({searchKey:''})" matSuffix>close
                    </mat-icon>
                    }
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>{{ "knowledge.category" | translate }}</mat-label>
                    <input formControlName="searchCategory" matInput />
                    @if(!searchCookieForm.value.searchCategory){
                    <mat-icon matSuffix>search</mat-icon>
                    }@else if(searchCookieForm.value.searchCategory.length>0){
                    <mat-icon (click)="searchCookieForm.patchValue({searchCategory:''})" matSuffix>close
                    </mat-icon>
                    }

                </mat-form-field>
            </ng-container>
            }
            }
        </div>
    </div>
    <div class="row">
        <div class="small-9 medium-9 columns">
            @switch (base.category) {
                @case('cookie'){
                    <table matSort (matSortChange)="sortBy($event)" class="base-list-table">
                        <thead>
                            <tr>
                                <th style="width:75px;"></th>
                                <th mat-sort-header="domain" colspan="2">
                                    <a><span>{{ "knowledge.domain" | translate }}</span></a>
                                </th>
                                <th mat-sort-header="name" style="width:75px;">
                                    <a><span>{{ "knowledge.name" | translate }}</span></a>
                                </th>
                                <th mat-sort-header="category" style="width:75px;text-align:center;">
                                    <a><span> {{ "knowledge.category" | translate }}</span></a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(item of cookieKnowledges; track item.id){
                                <tr [class.noElementsDisplaying]="showForm">
                                    <td class="base-listsBlock-item">
                                        <a href="javascript:;" (click)="duplicate(item.id)" class="btn base-tooltip">
                                            <mat-icon>content_copy</mat-icon>
                                            <span title="dupplicate" class="base-tooltip-text">
                                                {{ "entries.dupplicate" | translate }}
                                            </span>
                                        </a>
                                        <a (click)="delete($index)" class="btn base-tooltip">
                                            <mat-icon>delete</mat-icon>
                                            <span title="Remove" class="base-tooltip-text">{{ "entries.remove" | translate
                                                }}
                                            </span>
                                        </a>
                                    </td>
                                    <td class="base-listsBlock-item-click" (click)="editEntry(item.id)" colspan="2">
                                        <ng-container>{{
                                            item.domain
                                            }}</ng-container>
                                    </td>
                                    <td class="base-listsBlock-item-click" (click)="editEntry(item.id)">
                                        {{item.name}}
                                    </td>
                                    <td class="base-listsBlock-item-click" (click)="editEntry(item.id)"
                                        style="text-align:center;">
                                        {{
                                        item.category
                                        }}
                                    </td>
    
                                    <!-- Display element data block in absolute -->
                                    <td class="base-knowledges_base-displayData">
                                        <h3>
                                            {{base.category}}
                                        </h3>
                                        <div class="base-knowledges_base-displayData-category">
                                            {{item.category}}
                                        </div>
                                        <div class="base-knowledges_base-displayData-description">
                                            <ng-container>
                                                {{ "knowledge.domain" | translate }} : {{item.domain}} <br>
                                            </ng-container>
                                            <ng-container>
                                                {{ "knowledge.name" | translate }} : {{item.name}} <br>
                                            </ng-container>
                                            <ng-container>
                                                {{ "knowledge.source" | translate }} : {{item.source}} <br>
                                            </ng-container>
                                            <ng-container>
                                                {{ "knowledge.data_controller" | translate }} : {{item.controller}} <br>
                                            </ng-container>
                                            <ng-container>
                                                {{ "knowledge.privacy_policy" | translate }} : {{item.policy}} <br>
                                            </ng-container>
                                            <ng-container>
                                                {{ "knowledge.referenced_in" | translate }} : {{item.reference}} <br>
                                            </ng-container>
                                            <ng-container>
                                                {{ "knowledge.comments" | translate }} : <br>
                                                <div [innerHTML]="item.comment"></div>
                                            </ng-container>
                                        </div>
                                    </td>
                                </tr>
                            }
                            
                        </tbody>
                    </table>
                }
                @case('localstorage'){
                    <table matSort (matSortChange)="sortBy($event)" class="base-list-table">
                        <thead>
                            <tr>
                                <th style="width:75px;"></th>
                                <th mat-sort-header="script" colspan="2">
                                    <a><span>{{ "knowledge.script" | translate }}</span></a>
                                </th>
                                <th mat-sort-header="key" style="width:75px;">
                                    <a><span>{{ "knowledge.key" | translate }}</span></a>
                                </th>
                                <th mat-sort-header="category" style="width:75px;text-align:center;">
                                    <a><span> {{ "knowledge.category" | translate }}</span></a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(item of localStorageKnowledges; track item.id){
                                <tr
                                [class.noElementsDisplaying]="showForm">
                                <td class="base-listsBlock-item">
                                    <a href="javascript:;" (click)="duplicate(item.id)" class="btn base-tooltip">
                                        <mat-icon>content_copy</mat-icon>
                                        <span title="dupplicate" class="base-tooltip-text">
                                            {{ "entries.dupplicate" | translate }}
                                        </span>
                                    </a>
                                    <a (click)="delete(item.id)" class="btn base-tooltip">
                                        <mat-icon>delete</mat-icon>
                                        <span title="Remove" class="base-tooltip-text">{{ "entries.remove" | translate
                                            }}
                                        </span>
                                    </a>
                                </td>
                                <td class="base-listsBlock-item-click" (click)="editEntry(item.id)" colspan="2">
                                    <ng-container>{{
                                        item.script
                                        }}</ng-container>
                                </td>
                                <td class="base-listsBlock-item-click" (click)="editEntry(item.id)">
                                    {{item.key}}
                                </td>
                                <td class="base-listsBlock-item-click" (click)="editEntry(item.id)"
                                    style="text-align:center;">
                                    {{
                                    item.category
                                    }}
                                </td>

                                <!-- Display element data block in absolute -->
                                <td class="base-knowledges_base-displayData">
                                    <h3>
                                        {{base.category}}
                                    </h3>
                                    <div class="base-knowledges_base-displayData-category">
                                        {{item.category}}
                                    </div>
                                    <div class="base-knowledges_base-displayData-description">
                                        <ng-container>
                                            {{ "knowledge.key" | translate }} : {{item.key}} <br>
                                        </ng-container>
                                        <ng-container>
                                            {{ "knowledge.script" | translate }} : {{item.script}} <br>
                                        </ng-container>
                                        <ng-container>
                                            {{ "knowledge.source" | translate }} : {{item.source}} <br>
                                        </ng-container>
                                        <ng-container>
                                            {{ "knowledge.data_controller" | translate }} : {{item.controller}} <br>
                                        </ng-container>
                                        <ng-container>
                                            {{ "knowledge.privacy_policy" | translate }} : {{item.policy}} <br>
                                        </ng-container>
                                        <ng-container>
                                            {{ "knowledge.referenced_in" | translate }} : {{item.reference}} <br>
                                        </ng-container>
                                        <ng-container>
                                            {{ "knowledge.comments" | translate }} : <br>
                                            <div [innerHTML]="item.comment"></div>
                                        </ng-container>
                                    </div>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                }
            }
        </div>

        <!-- NEW ENTRY FORM -->
        <div class="small-3 medium-3 columns sticky-card">
            @if(showForm){
            <form (ngSubmit)="onSubmit()" [formGroup]="entryForm" class="base-knowledges_base-form">
                <button mat-button (click)="showForm=false" class="base-knowledges_base-form-close" type="button">
                    <mat-icon>close</mat-icon>
                </button>
                <h3>
                    {{base.category}}
                </h3>
                <div>
                    <div class="base-elementCategory-wrapper">
                        <select name="category" formControlName="category" (change)="focusOut()" required>
                            <option value="null" disabled>{{ "knowledge.category" | translate }}</option>
                            @for (category of categories; track category) {
                                <option value="{{ category }}">{{category}}
                                </option>
                            }
                            <option value="new_category">{{ "knowledge.new_category" | translate }}</option>
                        </select>
                    </div>
                </div>

                @if(entryForm.get('category')?.value == "new_category"){
                <span class="flex-container">
                    <a class="add-category-link" href="javascript:void(0)" (click)="addCategory(newCategoryValue)">
                        <mat-icon class="add-category-icon">add_box</mat-icon>
                    </a>
                    <input class="new-category-input" 
                    [(ngModel)]="newCategoryValue"
                    [ngModelOptions]="{ standalone: true }"
                    type="text" 
                    [placeholder]="'knowledge.enter_a_category' | translate" name="new_category" 
                    (keyup.enter)="addCategory(newCategoryValue)"
                    />     
                </span>
                }
               
                
                @switch (base.category) {
                @case('cookie'){
                <label for="domain">{{ "knowledge.domain" | translate }}:</label>
                <input (focusout)="focusOut()" formControlName="domain" type="text" placeholder="domain" name="domain"
                    required />
                <label for="name">{{ "knowledge.name" | translate }}:</label>
                <input (focusout)="focusOut()" formControlName="name" type="text" placeholder="name" name="name"
                    required />
                }
                @case('localstorage'){
                <label for="domain">{{ "knowledge.key" | translate }}:</label>
                <input (focusout)="focusOut()" formControlName="key" type="text" placeholder="key" name="key"
                    required />
                <label for="name">{{ "knowledge.script" | translate }}:</label>
                <input (focusout)="focusOut()" formControlName="script" type="text" placeholder="script" name="script"
                    required />
                }

                }

                <div>
                    <label for="source">{{ "knowledge.source" | translate }}:</label>
                    <input (focusout)="focusOut()" formControlName="source" type="text" placeholder="source"
                        name="source" />
                </div>
                <div>
                    <label for="controller">{{ "knowledge.data_controller" | translate }}:</label>
                    <input (focusout)="focusOut()" formControlName="controller" type="text" placeholder="controller"
                        name="controller" />
                </div>
                <div>
                    <label for="policy">{{ "knowledge.privacy_policy" | translate }}:</label>
                    <input (focusout)="focusOut()" formControlName="policy" type="text" placeholder="policy"
                        name="policy" />
                </div>
                <div>
                    <label for="reference">{{ "knowledge.reference_type" | translate }}:</label>
                    <input (focusout)="focusOut()" formControlName="reference" type="text" placeholder="reference"
                        name="reference" />
                </div>

                <div>
                    <label for="comment">{{ "knowledge.comments" | translate }}:</label>
                    <textarea (focusout)="focusOut()" formControlName="comment" type="text" placeholder="comment"
                        name="comment"></textarea>
                </div>
                <!-- Submit button (new element) -->
                @if(editMode === 'new'){
                <button type="submit" [disabled]="entryForm.invalid || entryForm.get('category')?.value == 'new_category'" class="btn btn-red" id="structure-save-card-btn"
                    title="{{ 'knowledge.new_entry' | translate }}">
                    {{ "knowledge.new_entry" | translate }}
                </button>
                }
            </form>
            }


        </div>

    </div>

    <!-- Import/export functions -->
    <div class="hide">
        <form enctype="multipart/form-data" [formGroup]="updateForm">
            <input type="file" formControlName="import_file" id="import_file" (change)="updateEntries($event)"
                class="hide" />
        </form>
        <a href="" id="base-exportBlock"></a>
    </div>