<mat-toolbar>
    <mat-toolbar-row class="navigation-header">
        <li class="breadcrumb-item">
            <a>
                <a [routerLink]="['/entries']">
                    <strong>
                        {{ "header.analyses" | translate }}
                    </strong>
                </a>
            </a>
        </li>
        <li class="breadcrumb-item">
            @if(tag){
                <a [routerLink]="['/analysis', analysis.id]">
                    {{ analysis.name }}
                </a>
            }@else {
                {{ analysis.name }}
            }
        </li>
        @if(tag){
            <li class="breadcrumb-item">
                @if(card){
                    <a [routerLink]="['/analysis', analysis.id,'tag',tag.id]">
                        {{ tag.name }}
                    </a>
                }@else {
                    {{ tag.name }}
                }
            </li>
        }
        @if(card){
            <li class="breadcrumb-item">
                {{ card.name }}
            </li>
        }

        <!--
        <span class="header-spacer"></span>
        <strong>
            EN
        </strong>
        <mat-icon aria-hidden="false" aria-label="Example languageicon">language</mat-icon> -->
    </mat-toolbar-row>
</mat-toolbar>

<mat-toolbar class="page-header" role="heading">
    <div style="margin-left: 30px;">
        @if(editing){
            <button (click)="close_edition()" mat-raised-button color="blue"> <mat-icon aria-hidden="false" aria-label="close comment">close</mat-icon> {{ "analyses.evaluation.close_edition" | translate }} </button>        
        }@else {
            <button (click)="start_edition()" mat-raised-button color="blue"> <mat-icon aria-hidden="false" aria-label="edit comment">edit</mat-icon>  {{ "header.edit" | translate }} </button>
        }
        
        <button [disabled]="editing" (click)="export('json')" mat-raised-button color="blue"> <i class="fas fa-file-import"></i> {{ "reports.save_as" | translate }}
            JSON</button>
        <button [disabled]="editing" (click)="export('xlsx')" mat-raised-button color="blue"> <i class="fas fa-file-import"></i> {{ "reports.save_as" | translate }}
                XLSX</button>
        <button [disabled]="editing" (click)="export('html')" mat-raised-button color="blue"> <i class="fas fa-file-import"></i> {{ "reports.save_as" | translate }}
            HTML</button>
        <button [disabled]="editing" (click)="export('pdf')" mat-raised-button color="blue"><i class="fas fa-file-import"></i> {{ "reports.save_as" | translate }} PDF
        </button>
        <button [disabled]="editing" (click)="export('docx')" mat-raised-button color="blue"><i class="fas fa-file-import"></i> {{ "reports.save_as" | translate }} Docx
        </button>
    </div>
</mat-toolbar>
<app-toolbar
[editing]="editing"
[pug]="pug"
[saveOption]="saveOption"
></app-toolbar>

<mat-card class="example-container">
    <mat-card-header>
        <mat-form-field appearance="fill">
            <mat-label> {{ "reports.select_template" | translate }} </mat-label>
            <mat-select [(value)]="selected_template" (selectionChange)="rendererHTML()">
                @for( template of templates; track template.id){
                    <mat-option [value]="template">{{template.name}}</mat-option>
                }
            </mat-select>
        </mat-form-field>
        @switch(report_level){
            @case('analysis'){
                <mat-form-field appearance="fill">
                    <mat-label> {{ "reports.select_tags" | translate }} </mat-label>
                    <mat-select 
                    [formControl]="tags_to_display"  multiple>
                    <mat-option #allSelectedTag  [value]="'All tags'" (click)="toggleAllTagSelection()"> {{ "reports.all_tags" | translate }} </mat-option>
                       <mat-select-trigger>
                            {{tags_to_display.value?.[0] || ''}}
                            @if((tags_to_display.value?.length || 0) > 1){
                                <span class="example-additional-selection">
                                    (+{{(tags_to_display.value?.length || 0) - 1}} {{tags_to_display.value?.length === 2 ? 'other tag' : 'others tags'}})
                                  </span>
                            }

                          </mat-select-trigger>
                          @for(tags_option of tags_options; track tags_option){
                            <mat-option [value]="tags_option" (click)="toggleTagSelection(tags_option)">{{tags_option}}</mat-option>
                          }
                    </mat-select>
                </mat-form-field>
            }
        }
        @if(report_level == 'analysis' || report_level == 'tag'){
            <mat-form-field appearance="fill">
                <mat-label> {{ "reports.select_cards" | translate }} </mat-label>
                <mat-select [formControl]="cards_to_display" multiple>
                   <mat-select-trigger>
                        {{cards_to_display.value?.[0] || ''}}
                        @if((cards_to_display.value?.length || 0) > 1){
                            <span class="example-additional-selection">
                                (+{{(cards_to_display.value?.length || 0) - 1}} {{cards_to_display.value?.length === 2 ? 'other card' : 'others cards'}})
                              </span>
                        }
                      </mat-select-trigger>
                  <mat-option #allSelectedCard (click)="toggleAllCardsSelection()" [value]="'All cards'">{{ "reports.all_cards" | translate }}</mat-option>
                  @for(cards_option of cards_options; track cards_option){
                    <mat-option [value]="cards_option" (click)="toggleCardSelection(cards_option)">{{cards_option}}</mat-option>
                  }
                </mat-select>
            </mat-form-field>
        }
        
        <mat-form-field appearance="fill">
            <mat-label> {{ "reports.select_evaluations" | translate }} </mat-label>
            <mat-select [formControl]="evaluations_to_display" multiple>
              <mat-select-trigger>
                    {{evaluations_to_display.value?.[0] || ''}}
                    @if((evaluations_to_display.value?.length || 0) > 1){
                        <span class="example-additional-selection">
                            (+{{(evaluations_to_display.value?.length || 0) - 1}} {{evaluations_to_display.value?.length === 2 ? 'other evaluation' : 'others evaluations'}})
                          </span>
                    }
                  </mat-select-trigger>
              <mat-option #allSelectedEvaluation (click)="toggleAllEvaluationsSelection()" [value]="'All evaluations'"> {{ "reports.all_evaluations" | translate }}</mat-option>
              @for(evaluation_option of evaluation_options; track evaluation_option){
                <mat-option [value]="evaluation_option" (click)="toggleEvaluationSelection(evaluation_option)">{{evaluation_option}}</mat-option>
              }
              
            </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill">
            <mat-label> {{ "reports.select_annex" | translate }} </mat-label>
            <mat-select [(value)]="selected_annex" (selectionChange)="rendererHTML()">
                <mat-option [value]=""></mat-option>
                @for(annex of annexes; track annex.id){
                    <mat-option [value]="annex">{{annex.name}}</mat-option>
                }
            </mat-select>
        </mat-form-field>
    </mat-card-header>
    <mat-card-content>

        <mat-form-field
        [ngClass]="{
            hide:editing==false}"
            style="width: 100%;"
        >
            <textarea matInput id="report_editor" [innerHTML]="pug| safeHtml"
            ></textarea>
        </mat-form-field>

        <app-report-renderer 
        [html]="pug"
        [ngClass]="{
            hide:editing==true}"
        ></app-report-renderer>
    </mat-card-content>
</mat-card>


<div class="hide">
    <a href="" id="base-exportBlock"></a>
</div>